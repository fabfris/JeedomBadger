= Configuration du plugin

Après téléchargement du plugin il vous faut l'activer, aucune configuration n'est necessaire. Vous pouvez vous rendre immédiatement sur la page du plug-in apres activation pour gérer les équipements.


== Configuration du materiel

Ce plug-in s'interface avec des arduino / ESP connectés en réseau éxécutant un sketch spécifique. Sur ces arduino on connecte le lecteur de badge wiegand. Le protocol wiegand permet une longue distance de câble entre l'arduino et le lecteur.
Les lecteurs de badge doivent supporter au moins un des protocoles wiegand 8,26 ou 34.  Les lecteurs peuvent etre RFID (125 Khz) ou NFC ( 13.56 Mhz) et pourvu ou non d'un clavier a code. 
Exemple : https://www.zkteco.eu/index.php/categories-11/access-control-systems/rfid-external-readers
Ces lecteurs sont disponible dans différents design a bas prix sur les sites chinois ou ebay ( Rechercher "wiegand"). 

image::../images/Screen3.png[]

Plusieurs exemple de sketch arduino sont fourni ( voir la page de configuration du plug-in )

=== Arduino + Interface reseau ENC28J   	

( Testé sur Duemilanove 168/328 et Uno )
Dans ce sketch 2 parametres sont a définir :  L'adresse IP du serveur Jeedom et le Numero de lecteur sur le reseau ( a incrémenter )

image::../images/inosettings_enc28j60.png[]

Câblage :

image::../images/arduinowiring_enc28j60.png[]

=== Arduino + Interface reseau W5100 		

( Testé sur Uno et Mega 2560 )
Dans ce sketch 2 parametres sont a définir :  L'adresse IP du serveur Jeedom et le Numero de lecteur sur le reseau ( a incrémenter )

image::../images/inosettings_w5100.png[]

Câblage :

image::../images/arduinowiring_w5100.png[]

Attention un lecteur RFID necessite au moins du 9V voir du 12V si il est muni d'un clavier. Une tension inférieure lui fera perdre en porté de lecture RFID.  Il est fortement déconseillé d'utiliser la broche VIN de l'arduino pour alimenter le lecteur en cas de branchement en USB vous allez griller votre arduino. 
Le 12V peu etre pris en amont de l'arduino et utiliser une alimentation commune.


== Configuration des équipements

La configuration des équipements Badger est divisée en 4 sections : Configuration générale, Lecteurs, Badges et Codes. 

image::../images/Screen1.png[]

=== Configuration générale

La configuration générale dispose d'un raccourci vers la page de configuration/installation du plug-in, un lien vers la documentation, et un bouton pour activer ou désactiver le mode inclusion.
Le mode inclusion permet d'ajouter automatiquement un nouveau lecteur de badge ou d'enregistrer un nouveau badge.

Pour ajouter un nouveau lecteur de badge , il faudra donc suivre la procedure suivante :
- Configurer l'arduino ( cf chapitre configuration du materiel )
- Activer le mode inclusion sur Jeedom
- Utiliser le nouveau lecteur de badge avec un badge.
Le nouveau lecteur apparaitra alors dans la liste des lecteurs ( un rechargement de la page peut etre necessaire )
Selectionnez ce nouveau lecteur pour le configurer ( cf chapitre suivant )

=== Configuration des lecteurs

La configuration des lecteurs permet d'ajuster certains parametres du lecteur. Elle doit etre effectuée et sauvegardé apres chaque ajout de nouveau lecteur.

image::../images/Screen2.png[]

* Le nom de l'equipement dans jeedom.
* L'objet parent jeedom (optionel).
* Activer / Desactiver ( un lecteur desactivé sera ignoré par le plug-in).
* Visible / Invisible ( dans jeedom )
* ID (ce parametre ne peu pas etre changé)  Cette ID est composé du mot BADGER et du numero de lecteur défini dans le sketch Arduino.
* IP / HostName (ce parametre ne peu pas etre changé)  Cette IP est défini par le DHCP de votre réseau.
* Le model determine la liste des fonctionalités du lecteur et les parametres disponibles pour celui-ci.
* Le temps de blocage défini le temps (en minutes) pendant lequel jeedom ignorera les commandes provenant de ce lecteur lorsque celui-ci est "bloqué" (voir limite ci dessous).
* Le compteur de badge inconnu (ce parametre ne peu pas être changé) affiche le nombre de badge inconnu présenté successivement. Ce compteur sera ré-initialisé par la présenation d'un badge valide si le lecteur n'est pas bloqué.
* La Limite de badge inconnu défini le nombre maximum de badge inconnu qui peuvent être présenté avant blocage. Si cette limite est atteinte , le lecteur sera bloqué pendant le temps défini ci dessus.
* Le compteur de code faux (ce parametre ne peu pas être changé) affiche le nombre de faux (inconnu) présenté successivement. Ce compteur sera ré-initialisé par la présenation d'un code valide si le lecteur n'est pas bloqué.
* La Limite de code faux défini le nombre maximum de code faux (inconnu) qui peuvent être présenté avant blocage. Si cette limite est atteinte , le lecteur sera bloqué pendant le temps défini ci dessus.


=== Configuration des badges

La configuration des badges permet d'ajuster certains parametres. Elle doit etre effectuée et sauvegardé apres chaque ajout de nouveau badge.

image::../images/Screen4.png[]

* Le nom de l'equipement dans jeedom.
* L'objet parent jeedom (optionel).
* Activer / Desactiver ( un badge desactivé sera ignoré par le plug-in).
* Visible / Invisible ( dans jeedom )
* Le model est purement informatif dans cette version. Il servira dans une prochaine version du plug-in a determiner le type d'identification a utiliser.
* La valeur (ce parametre ne peu pas être changé) affiche l'identifiant lu sur le badge en decimal.

=== Configuration des codes

La configuration des codes permet d'ajuster certains parametres. Elle doit etre effectuée et sauvegardé apres chaque ajout de nouveau code.

image::../images/Screen5.png[]

* Le nom de l'equipement dans jeedom.
* L'objet parent jeedom (optionel).
* Activer / Desactiver ( un badge desactivé sera ignoré par le plug-in).
* Visible / Invisible ( dans jeedom )
* La valeur du code secret. La longueur maximum est de 24 chiffres.

Les codes ne sont pas créés par inclusion automatique. Il faut utiliser le bouton "Ajouter" pour créer un nouveau code.


== Fonctionement et Utilisation des equipements

Le plug-in n'execute que tres peu de tache en automatique , il met simplement a disponibilité des equipements et des commandes a utiliser dans vos propres scenarios. Des exemples de scenarios sont disponible dans cette documentation.

=== Fonctions automatiques

En automatique le plug-in va gerer la présentation de codes faux et de badges inconnu en bloquant le lecteur pendant une période donnée. Les parametres de chaque lecteur ajuste cette fonctionalitée, elle est tres importante en terme de sécurité. Elle permet de bloquer une attaque brute du lecteur. 
Lorsque un lecteur atteint sa limite de code faux , la commande "PinTryLimit" (type info-string) est déclenchée et une erreur est inscrite dans les logs.
Lorsque un lecteur atteint sa limite de badges inconnu , la commande "TagTryLimit" (type info-string) est déclenchée et une erreur est inscrite dans les logs.
On peu alors déclencher un scenario sur ces commandes pour prévenir quelqu'un , déclencher une "pré" alarme .. etc..

=== Fonctions configurable dans jeedom

==== Test de présentation de badge ou code

Lors de la présentation d'un code ou d'un badge connu et actif , la commande "Presentation" (type info-string) est déclenchée , cette commande contient un texte avec le format suivant :  (Date) (Heure) - (Nom du lecteur utilisé)
La commande "BadgerID" (type info-string) est aussi mise à jours avec le nom du lecteur utilisé.

Ces commandes peuvent etre utilisées dans un scenario pour déclencher une action ( ouverture de porte , desactivation d'alarme ...)
Voici un premier example simple :

image::../images/Screen6.png[]
Ce scenario simple est déclenché par la présentation d'un code ou d'un badge. On peu ajouter d'autres codes ou badge comme déclencheurs. 

image::../images/Screen7.png[]
Ici le scenario test sur quel lecteur le code ou badge a été présenté. Et dans ce cas il pourrait déclencher l'ouverture d'une porte associée a ce lecteur.  Ici je met juste a jours une variable debug pour la démo.

un deuxieme example plus complexe , nous voulons une double authentification badge + code :

image::../images/Screen8.png[]
Ce scenario simple est déclenché uniquement par la présentation d'un badge précis. 

image::../images/Screen9.png[]
Ici le scenario test sur quel lecteur le code ou badge a été présenté puis attend 20 secondes que le code défini soit entré. Si le bon code n'est pas entré dans les 20 secondes , le scenario est annulé et le badge doit etre a nouveau présenté. 

==== Activation / Desactivation d'un code ou badge

En associant le plug-in agenda , on peu définir une plage horaire pendant laquelle un badge ou code sera actif. En utilisant la fonction activer / desactiver du scenario.

image::../images/Screen10.png[]

==== Génération d'un code temporaire

Les Codes dispose de 2 commandes supplémentaires pour generer ,definir et obtenir une nouvelle valeur de code.
La commande "ChangePin" (type message string)  permet de définir ou de générer un nouveau code. La syntax de cette commande est la suivante :
[width="85%"",options="header"]
|=======
|Titre | Message | Description
|"set"	 	|Valeur du nouveau code | Défini un nouveau code 
|"rnd4"	 	| (vide)	| Génère un nouveau code aléatoire sur 4 chiffres
|"rnd6"	 	| (vide)	| Génère un nouveau code aléatoire sur 6 chiffres
|"rnd8"	 	| (vide)	| Génère un nouveau code aléatoire sur 8 chiffres
|=======

La commande "GetPin" (type info string) permet de récuperer la valeur courante du code.

Un scenario possible : pour donner acces temporairement a votre habitation a quelqu'un alors que vous n'avez pas acces a Jeedom :  déclenché par un sms , un scenario génére un code temporaire , l'active et renvoi sa valeur par sms. Le scenario desactive ce code au bout de 1 heure.
Comme il n'est pas possible de creer des nouveaux codes. Au préalable on aura créé un code nommé "temporaire" que l'on aura desactivé.



